<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Decodeur - 1.0</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
    
    <script src="bootstrap-3.3.6/dist/js/bootstrap.min.js"></script>
    <script src="bootstrap-3.3.6/dist/js/npm.js"></script>

    <link href="bootstrap-3.3.6/dist/css/bootstrap.min.css" rel="stylesheet">   

    <link rel="stylesheet" href="app.css" type="text/css"/>

    <script src="app.js"></script>
    <script src="Blockly/appengine/storage.js"></script>
    <script src="Blockly/blockly_uncompressed.js"></script>
    <!--<script src="Blockly/blocks_compressed.js"></script>-->

    <!--Blocks-->
    <script src="Blockly/blocks/colour.js"></script>
    <script src="Blockly/blocks/custom.js"></script>
    <script src="Blockly/blocks/custom_if.js"></script>
    <script src="Blockly/blocks/lists.js"></script>
    <script src="Blockly/blocks/logic.js"></script>
    <script src="Blockly/blocks/loops.js"></script>
    <script src="Blockly/blocks/math.js"></script>
    <script src="Blockly/blocks/procedures.js"></script>
    <script src="Blockly/blocks/text.js"></script>
    <script src="Blockly/blocks/variables.js"></script>

    <!-- To show xml with angular -->
    <!--<script src="Scripts/jquery-3.0.0.min.js"></script>-->
    <script src="Scripts/angular.min.js"></script>

    <!-- Overriden version of the core -->
    <script src="Blockly/core_override/procedures.js"></script>
    <script src="Blockly/core_override/variables.js"></script>

    <!-- Messages -->
    <script src="Blockly/msg/js/fr.js"></script>
    <script src="Dev/dev-mode.js"></script>

    <!--Csharp generator-->
    <script src="Blockly/generators/csharp.js"></script>
    <script src="Blockly/generators/csharp/variables.js"></script>
    <script src="Blockly/generators/csharp/lists.js"></script>
    <script src="Blockly/generators/csharp/colour.js"></script>
    <script src="Blockly/generators/csharp/logic.js"></script>
    <script src="Blockly/generators/csharp/math.js"></script>
    <script src="Blockly/generators/csharp/loops.js"></script>
    <script src="Blockly/generators/csharp/procedures.js"></script>
    <script src="Blockly/generators/csharp/text.js"></script>
    <script src="Blockly/generators/csharp/inferboilerplate.js"></script>
    <script src="Blockly/generators/csharp/inferbool_variables.js"></script>
    <script src="Blockly/generators/csharp/inferdistributions.js"></script>
    <script src="Blockly/generators/csharp/inferdouble_variables.js"></script>
    <script src="Blockly/generators/csharp/custom.js"></script>

    <script src="postCode.js"></script>
    <script src="Variables/values.js"></script>

    <!--AutoCompletion-->
    <script src="autocomplete_util.js"></script>
    <link rel="stylesheet" href="closure-library/closure/goog/css/autocomplete.css" type="text/css"/>
    <script>goog.require('goog.ui.ac');</script>

</head>

<body id="body" onkeydown="Squid.Dev.ToggleDevmode(event)">

<div class="top-layer full-height">
    <div class="generated-code full-height" id="generated-code">
        <h1 class="no-margin"> Code généré </h1>
        <pre id="content1"></pre>
    </div>

    <aside class="side-bar full-height">
        <div class="row full-height">
            <aside class="code-hide full-height col-lg-2">
                <button id="code-hide" onclick="hideGenerated()">
                    <div class="rotate"> Générer </div>
                </button>
            </aside>
            <div class="col-lg-10">
                <div id="blocklyDivConfiguration" class="" style="display:none"></div>
                <div class="configuration">
                    <h1>Configuration</h1>
                    <div class="toolbar-workspace">
                        <div class="toolbar-items">
                            <div class="toolbar-group">
                                <button class="item-workspace save" title="Sauvegarde les variables" onclick="saveConfig()"></button>
                                <div class="inline-block">
                                    <button class="item-workspace restore"
                                            title="Restore un set de variables"
                                            onclick="launchDropdownRestoreConfig(this)">                                      
                                    </button>
                                </div>                                      
                                <button class="item-workspace clear" title="Efface les fonctions enregistrées" onclick="deleteConfig()"></button>
                                <button class="item-workspace add" title="Ajouter une variable" onclick="createConfig()"></button>
                            </div>
                            <div class="toolbar-group">
                                <span id="config-title">Set défaut</span>
                            </div>
                        </div>
                        <table id="config-table"></table>
                    </div>       
                </div>

                <div>
                    <h1>Inventaire</h1>
                    <div class="toolbar-workspace">
                        <div class="toolbar-group">
                            <button class="item-workspace save" title="Sauvegarde les variables" onclick="saveConfig()"></button>
                            <div class="inline-block">
                                <button class="item-workspace restore"
                                        title="Restore un set de variables"
                                        onclick="launchDropdownRestoreConfig(this)"></button>
                            </div>
                            <button class="item-workspace clear" title="Efface les fonctions enregistrées" onclick="deleteConfig()"></button>
                            <button class="item-workspace add" title="Ajouter une variable" onclick="createInventory()"></button>
                        </div>
                        <table id="inventory-table"></table>
                    </div>
                </div>

                <div id="Values">
                    <h1>Valeurs</h1>

                </div>
                <!--<button class="item-workspace" onclick="Squid.displaySimpleVariables()">Rafraîchir valeurs</button>-->

                <div id="decodingTest">
                    <h1>Tester le décodeur</h1>
                    <input id="valeur-a-decoder" type="text" value="valeur à décoder"/>
                    <input id="nom-decodeur" type="text" value="nom du décodeur"/>
                    <input id="resultat" type="text" class="textarea" value="resultat"/>
                </div>

                

            </div>
        </div>
    </aside>
</div>

<div class="row">
    <div class="col-md-9">
        <div id="wrapper">
            <div class="edition-window decode-window">
                <div class="toolbar-workspace">
                    <div class="title-toolbar-workspace"> Editeur de décodeur </div>

                    <div class="toolbar-items">

                        <div class="toolbar-group">
                            <button class="item-workspace save" title="Sauvegarde les fonctions" onclick="Save()"></button>
                            <button class="item-workspace clear" onclick="ClearFunction();" title="Efface les fonctions enregistrées"></button>
                        </div>
                        <!-- Adding the search bar for tags -->
                        <div class="toolbar-group">
                            <input class="item-workspace" id="search-bar" type="text" placeholder="tag1, tag2, ..." value="" />
                            <button class="item-workspace research" onclick="TagSearch(workspace, 'toolboxGeneric')" title="Rechercher les tags"></button>
                        </div>
                        <div class="toolbar-group">
                              <button class="item-workspace refresh" onclick="Refresh();" title="Rafraichit les fonctions"></button>
                        </div>
                    </div>
                </div>
                <div id="blocklyDiv" class="blocklyDiv"></div>
            </div>
            <!-- There is the hidden workspace which is supposed to contain all the function usable BUT not shown -->
            <div class="edition-window decode-window row dev-block">
                <div id="blocklyDivHidden" class="blocklyDiv dev-block"></div>
            </div>
        </div>
    </div>
</div>

<div ng-app="httpApp" ng-controller="httpController"></div>

<script src="Variables/ConfigAndInventoryViewModel.js"></script>
<script>
    var workspaceNames = new Array();
    var workspaceName = "FirstWorkspace";

    /* Workspaces */
    var workspace;
    var configWorkspace;
    var hiddenWorkspace;
    var activWorkspace;

    var valueActivWorkspace = -1;
    var nbWorkspaces = 0;
    var variablesCount = 0;
    var inventaireCount = 0;

    /*AutoCompletion*/
    var acTags;

    /* Element IDs */
    var princToolboxId = "toolboxGeneric";
    var BASE_BLOCKLY_DIV = "blocklyDiv";
    
    // Create a the main workspace
    var app = angular.module('httpApp', []);
    app.controller('httpController',
        function($scope, $http) {
            $http.get("Toolbox/toolboxCoreGenerics.xml", {})
                .success(function(response) {
                    document.getElementById("body").innerHTML += response;

                    workspace = Blockly.inject(BASE_BLOCKLY_DIV,
                    {
                        toolbox: document.getElementById(princToolboxId),
                        zoom:
                        {
                            controls: true,
                            wheel: true,
                            startScale: 1.0,
                            maxScale: 3,
                            minScale: 0.2,
                            scaleSpeed: 1.2
                        },
                        trashcan: true
                    });
                    activWorkspace = workspace;
                    hiddenWorkspace = Blockly.inject(BASE_BLOCKLY_DIV + "Hidden",
                    {
                        trashcan: true,
                        zoom:
                        {
                            controls: true,
                            wheel: true,
                            startScale: 1.0,
                            maxScale: 5.0,
                            minScale: 0.1,
                            scaleSpeed: 1.3
                        }
                    });
                    configWorkspace = Blockly.inject(BASE_BLOCKLY_DIV + "Configuration");
                    configWorkspace.attachChildWorkspace(workspace);
                    configWorkspace.newBlock("variables_get", "var");
                    Blockly.Variables.renameVariable(Blockly.Msg.VARIABLES_DEFAULT_NAME, "undefined", configWorkspace);
                    Squid.Variables.InitWorkspaces(configWorkspace);

                    workspace.attachChildWorkspace(hiddenWorkspace);
                    Squid.Storage.ReloadWorkspace(null, hiddenWorkspace);
                    Refresh();

                    Squid.Dev.HideDevmode();

                    /* AutoCompletion */
                    AutoComplete.variablesWorkspace = configWorkspace;
                    AutoComplete.categoryWorkspace = workspace;
                   
                    var autoCompleteTags = AutoComplete.GetTags();
                    acTags = goog.ui.ac.createSimpleAutoComplete(autoCompleteTags, document.getElementById('search-bar'), true, true);
                    acTags.setAutoHilite(false);

                    /* Simple Variables (not config nor inv) */
                    reloadVariables();

                });
        });

    function hideGenerated() {
        var gc = document.getElementById("generated-code");
        var b = document.getElementById("code-hide");
        var w = gc.style.width;
        var fullSize = '75%';
        if (gc.style.width !== fullSize) {
            generateCode();
            gc.style.width = fullSize;
            gc.style.opacity = 1;
        } else {
            gc.style.width = '0%';
            gc.style.opacity = 0;
        }
    }

    //------------------------------------------------------------------ Variables
    function createConfig() {
        Squid.Variables.create(Squid.Variables.Types.CONFIG);
        Refresh();
    }

    function createInventory() {
        Squid.Variables.create(Squid.Variables.Types.INVENTORY);
        Refresh();
    }

    function saveConfig() {
        Squid.Storage.SaveConfigs(
            Squid.Variables.getWorkspace(Squid.Variables.Types.CONFIG),
            $("#config-title").text()
            );
    }

    function launchDropdownRestoreConfig(button) {
        button = $(button);
        var locations = Squid.Storage.ConfigLocations;

        var ul = $("<ul>");
        ul.attr("class", "dropdown");

        for (var i = 0; i < locations.length; i++) {
            var li = $("<li>");
            li.html(locations[i]);
            li.on(restoreConfig(locations[i]));
            ul.append(li);
        }
        button.append(ul);
        setTimeout(function() { button.html(""); }, 2000);
    }

    function restoreConfig(location) {

        if (location) {
            var tConfig = Squid.Variables.Types.CONFIG;
            var workspace = Squid.Variables.getWorkspace(tConfig);

            var names = Blockly.Variables.allVariables(workspace);

            Squid.Variables.deleteAll(tConfig);
            Squid.Storage.RestoreConfigs(
                workspace,
                location
            );

            var prefix = Squid.Variables.getPrefix(tConfig);
            for (var i = 1; i < names.length; i++) {
                var l = prefix.length;
                var name = names[i].substr(l, names[i].length - l);
                Squid.Variables.create(tConfig, name);
            }
            $("#config-title").text(location);
        } else {
            console.warn("Specify a location");
        }
    }

    function deleteConfig() {
        Squid.Variables.deleteAll(Squid.Variables.Types.CONFIG);
    }

    
    //------------------------------------------------------------------ Tools
    /////**
    //// * Create a new workspace for editing a function.
    //// * @param {!Blockly.Workspace} workspace The workspace on which you want to add a function.
    //// */
    ////function createFunction(workspace) {
    ////    var funcWindow = document.getElementById("functionWrapper");
    ////    if (funcWindow.style.display === "none") {
    ////        funcWindow.style.display = "block";
    ////    }

    ////    // Hide the previous workspace
    ////    if (nbWorkspaces > 0) {
    ////        document.getElementById(BASE_BLOCKLY_DIV + valueActivWorkspace).style.display = "none";
    ////    }

    ////    // Create anchor
    ////    var newDiv = document.createElement('div');
    ////    newDiv.setAttribute("id", BASE_BLOCKLY_DIV + nbWorkspaces);
    ////    newDiv.setAttribute("class", BASE_BLOCKLY_DIV);
    ////    funcWindow.appendChild(newDiv);

    ////    // Create the workspace
    ////    var newWorkspace = Blockly.inject(BASE_BLOCKLY_DIV + nbWorkspaces,
    ////    { toolbox: document.getElementById('toolboxFunction') });
    ////    workspace.attachChildWorkspace(newWorkspace);
    ////    activWorkspace = newWorkspace;
    ////    valueActivWorkspace = nbWorkspaces;

    ////    // Create the onglet
    ////    var newOnglet = document.createElement('button');
    ////    newOnglet.setAttribute("class", "onglet");
    ////    newOnglet.setAttribute("name", "Nouveau");
    ////    newOnglet.setAttribute("id", "onglet" + nbWorkspaces);
    ////    newOnglet.setAttribute("value", nbWorkspaces);
    ////    newOnglet.setAttribute("checked", true);
    ////    newOnglet.setAttribute("onclick", "changeActiveWorkspace(" + nbWorkspaces + ")");
    ////    newOnglet.textContent = "Nouveau !";
    ////    document.getElementById("toolbar-onglet-func").appendChild(newOnglet);

    ////    nbWorkspaces++;
    ////}

    ////function changeActiveWorkspace(newValueActivWorkspace) {
    ////    document.getElementById(BASE_BLOCKLY_DIV + valueActivWorkspace).style.display = "none";
    ////    document.getElementById(BASE_BLOCKLY_DIV + newValueActivWorkspace).style.display = "block";
    ////    valueActivWorkspace = newValueActivWorkspace;
    ////}

    function generateCode() {
        var code = Blockly.CSharp.workspaceToCode(activWorkspace);
        var div = document.getElementById('content1');
        div.innerHTML = code;
    }

    function Refresh() {
        RefreshCategories(workspace, princToolboxId);
        //for autocompletion
        if (acTags) {
            acTags.matcher_ = new goog.ui.ac.ArrayMatcher(AutoComplete.GetTags(), true);
        }
       
    }

    function Save() {
        Squid.Storage.SaveFunction(workspace);
        saveVariables(Squid.SimpleVariables);
        Refresh();
    }

    function reload_(name) {
        if (window
            .confirm("Êtes vous sûr de vouloir recharger une trame ?\nTout changement non sauvegardé sera perdu.")) {
            workspaceName = name;
            Squid.Storage.ReloadWorkspace(workspace, null, workspaceName);
            var elem = document.getElementById("workspaceName");
            elem.innerHTML = workspaceName;
            Refresh();
        }
    }

    function Reload() {
        reload_(workspaceName);
    }

    function clearFunc(workspace) {
        var children = workspace.getLinkedWorkspace();
        for (var i = 0; i < children.length; i++) {
            children[i].clear();
            clearFunc(children[i]);
        }
    }

    function ClearFunction() {
        if (window
            .confirm("Êtes-vous sur de vouloir effacer toutes les fonctions ? A la prochaine sauvegarde, elle seront perdues.")) {
            clearFunc(workspace);
            Refresh();
        }
    }

</script>

<!-- Storage and parsing -->
<script src="Storage/storage.js"></script>
<script src="Storage/parsingXML.js"></script>
<script src="Toolbox/category.js"></script>

</body>
</html>